<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤æ˜åœ°ã“ã„ã—ã‚¢ãƒ—ãƒª</title>
    <link rel="icon" href="Img/epicenter.png">

    <!-- å¤–éƒ¨ã®CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="Styles.css">

    <!-- JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="MainScript.js"></script>
    <script src="P2P.js"></script>
    <script src="Wolfx.js"></script>
</head>

<body>
<!-- ç¾åœ¨æ™‚åˆ»ã‚’è¡¨ç¤º -->
<h1 id="now_time" aria-live="polite">2000/01/01 00:00:00</h1>

<!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
<textarea id="maintextarea" rows="1" readonly aria-label="ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢"></textarea>

<!-- éå»ã®æƒ…å ±ã‚’ã•ã‹ã®ã¼ã‚‹ãŸã‚ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
<input type="range" id="pagebar" min="0" max="0" value="0" aria-label="ãƒšãƒ¼ã‚¸ãƒãƒ¼">

<!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆã“ã„ã—ã¡ã‚ƒã‚“ï¼‰ã®è¡¨ç¤º -->
<div class="koisiarrow_box" aria-label="ã“ã„ã—ã®å¹ãå‡ºã—">å¤æ˜åœ°ã“ã„ã—ã ã‚ˆ!!</div>
<img src="Img/baclgroundimg.jpg" id="back" alt="èƒŒæ™¯ç”»åƒ">
<img src="Img/hyoujyou_bishou_koisi.png" id="koisi" alt="å¤æ˜åœ°ã“ã„ã—">

<!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
<nav id="menu" aria-label="ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
    <h2>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    <a id="linker" target="_blank" rel="noopener noreferrer" href="settings.html">è¨­å®š</a>
    <hr>
    <h2>ç¾åœ¨åœ°æƒ…å ±</h2>
    <h4 id="NowLocate">ä½ç½®æƒ…å ±å–å¾—ä¸­...</h4>

    <h3>WebSocket æ¥ç¶šçŠ¶æ…‹</h3>
    <div class="connection-status">
        <h4>P2Påœ°éœ‡æƒ…å ± API</h4>
        <span id="p2pStatusIndicator" class="status-indicator status-disconnected" aria-hidden="true"></span>
        <span id="p2pStatusText">åˆ‡æ–­</span>
    </div>
    <div class="connection-status">
        <h4>Wolfx JMA API</h4>
        <span id="wolfxStatusIndicator" class="status-indicator status-disconnected" aria-hidden="true"></span>
        <span id="wolfxStatusText">åˆ‡æ–­</span>
    </div>
</nav>

<!-- æƒ…å ±ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<aside id="infomenu" aria-label="æƒ…å ±ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
    <h2>æƒ…å ±ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
</aside>

<!-- æ“ä½œãƒœã‚¿ãƒ³ -->
<button id="toggleMenuBtn" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰" aria-expanded="false">â˜°</button>
<button id="toggleinfoMenuBtn" aria-label="æƒ…å ±ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰" aria-expanded="false">â˜°</button>
<button id="MapChange" aria-label="åœ°å›³è¡¨ç¤ºåˆ‡æ›¿">ğŸ—ºï¸</button>

<!-- åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ -->
<div id="LeafletMap" role="application" aria-label="åœ°å›³"></div>

<script>
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ========================================
    let AllWebsocketData = [];
    let isMapMode = false;
    let LeafletMapSet = null;
    let timeUpdateInterval = null;

    // åœ°å›³ãƒ‡ãƒ¼ã‚¿
    let PrefArea;
    let SaibunArea;
    let TsunamiArea;
    let PrefGeoJSON;
    let SaibunGeoJSON;
    let TsunamiGeoJSON;
    let EpspAreaData = null;

    // ãƒãƒ¼ã‚«ãƒ¼é¡
    const areaMarkers = new Map();
    let EpicenterMarker;
    const marker9611Map = new Map();
    let shindoMarkers = new Map();
    let userLocationMarker = null; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ãƒãƒ¼ã‚«ãƒ¼

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®æƒ…å ±ã‚’ä¿å­˜
    let userLocation = null;

    // ========================================
    // DOMè¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    // ========================================
    const elements = {};

    function cacheElements() {
        elements.nowTime = document.getElementById('now_time');
        elements.textarea = document.getElementById('maintextarea');
        elements.pagebar = document.getElementById('pagebar');
        elements.menu = document.getElementById('menu');
        elements.infomenu = document.getElementById('infomenu');
        elements.toggleMenuBtn = document.getElementById('toggleMenuBtn');
        elements.toggleInfoMenuBtn = document.getElementById('toggleinfoMenuBtn');
        elements.mapChangeBtn = document.getElementById('MapChange');
        elements.backImg = document.getElementById('back');
        elements.koisiImg = document.getElementById('koisi');
        elements.leafletMap = document.getElementById('LeafletMap');
        elements.koisiarrow = document.querySelector('.koisiarrow_box');
        elements.p2pIndicator = document.getElementById('p2pStatusIndicator');
        elements.p2pText = document.getElementById('p2pStatusText');
        elements.wolfxIndicator = document.getElementById('wolfxStatusIndicator');
        elements.wolfxText = document.getElementById('wolfxStatusText');
        elements.nowLocate = document.getElementById('NowLocate');
    }

    // ========================================
    // æ™‚è¨ˆã‚’å‹•ã‹ã™
    // ========================================
    function updateTime() {
        const now = new Date();
        const formatted = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
        if (elements.nowTime) {
            elements.nowTime.textContent = formatted;
        }
    }

    // ========================================
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
    // ========================================
    function toggleMenu(menuElement, btnElement) {
        const isOpen = menuElement.classList.toggle('open');
        if (btnElement) {
            btnElement.setAttribute('aria-expanded', isOpen);
        }
    }

    // ========================================
    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢æ›´æ–°
    // ========================================
    function updateMainTextarea(index) {
        if (!elements.textarea || index < 0 || index >= AllWebsocketData.length) {
            return;
        }

        let data = AllWebsocketData[index];

        if (typeof data === 'string') {
            try {
                data = JSON.parse(data);
            } catch (e) {
                elements.textarea.value = '(ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ)';
                return;
            }
        }

        if (data.code && typeof formatToTelop === 'function') {
            elements.textarea.value = formatToTelop(data);
        } else if (data.type && typeof wolfxcoverter === 'function') {
            elements.textarea.value = wolfxcoverter(data) ?? '(ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)';
        } else {
            elements.textarea.value = '(è¡¨ç¤ºã§ãã‚‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“)';
        }
    }

    // ========================================
    // ãƒšãƒ¼ã‚¸ãƒãƒ¼æ›´æ–°
    // ========================================
    function updatePagebar() {
        if (!elements.pagebar) return;
        const maxIndex = Math.max(0, AllWebsocketData.length - 1);
        elements.pagebar.max = maxIndex;
        elements.pagebar.value = maxIndex;
    }

    // ========================================
    // WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
    // ========================================
    function onP2PMessage(msg) {
        AllWebsocketData.push(msg);
        updatePagebar();
        if (typeof P2PMap === 'function') {
            P2PMap(msg);
        }
        updateMainTextarea(AllWebsocketData.length - 1);
    }

    function onWolfxMessage(msg) {
        AllWebsocketData.push(msg);
        updatePagebar();
        updateMainTextarea(AllWebsocketData.length - 1);
    }

    // ========================================
    // æ¥ç¶šçŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
    // ========================================
    function updateConnectionStatus(indicator, textElement, isConnected) {
        if (!indicator || !textElement) return;

        if (isConnected) {
            indicator.classList.remove('status-disconnected');
            indicator.classList.add('status-connected');
            textElement.textContent = 'æ¥ç¶šä¸­';
        } else {
            indicator.classList.remove('status-connected');
            indicator.classList.add('status-disconnected');
            textElement.textContent = 'åˆ‡æ–­';
        }
    }

    function onP2PStatusChange(isConnectedStr) {
        updateConnectionStatus(
            elements.p2pIndicator,
            elements.p2pText,
            isConnectedStr === 'true'
        );
    }

    function onWolfxStatusChange(isConnectedStr) {
        updateConnectionStatus(
            elements.wolfxIndicator,
            elements.wolfxText,
            isConnectedStr === 'true'
        );
    }

    // ========================================
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
    // ========================================
    function addUserLocationMarker() {
        if (!LeafletMapSet || !userLocation) return;

        // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
        if (userLocationMarker) {
            LeafletMapSet.removeLayer(userLocationMarker);
        }

        // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        userLocationMarker = L.marker([userLocation.lat, userLocation.lon])
            .addTo(LeafletMapSet)
            .bindPopup(`ã‚ãªãŸã®ç¾åœ¨åœ°: ${userLocation.place}<br>(${userLocation.lat.toFixed(2)}, ${userLocation.lon.toFixed(2)})`)
            .openPopup();

        // åœ°å›³ã®ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«
        LeafletMapSet.setView([userLocation.lat, userLocation.lon], 10);
    }

    // ========================================
    // åœ°å›³ã¨èƒŒæ™¯ã®åˆ‡ã‚Šæ›¿ãˆ
    // ========================================
    async function toggleMapMode() {
        isMapMode = !isMapMode;

        if (isMapMode) {
            // åœ°å›³ãƒ¢ãƒ¼ãƒ‰ã¸
            elements.backImg.style.display = 'none';
            elements.leafletMap.style.display = 'block';
            elements.koisiImg.style.height = '20vh';
            elements.koisiarrow.style.display = 'none';

            if (typeof KoishiFaceUpdate === 'function') {
                KoishiFaceUpdate('Img/koisiyukuri.png');
            }

            // åœ°å›³ã®åˆæœŸåŒ–
            if (!LeafletMapSet && typeof L !== 'undefined') {
                LeafletMapSet = L.map('LeafletMap').setView([35.681236, 139.767125], 5);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(LeafletMapSet);

                // GeoJSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                try {
                    PrefArea = await fetch("Item/Pref.geojson").then(res => res.json());
                    SaibunArea = await fetch("Item/Saibun.geojson").then(res => res.json());
                    TsunamiArea = await fetch("Item/Tsunami.geojson").then(res => res.json());

                    PrefGeoJSON = L.geoJSON(PrefArea, { style: { color: "green", fillOpacity: 0.0 } }).addTo(LeafletMapSet);
                    SaibunGeoJSON = L.geoJSON(SaibunArea, { style: { color: "red", fillOpacity: 0.0 } }).addTo(LeafletMapSet);
                    TsunamiGeoJSON = L.geoJSON(TsunamiArea, { style: { color: "blue", fillOpacity: 0.0 } }).addTo(LeafletMapSet);
                } catch (error) {
                    console.error("GeoJSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", error);
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                addUserLocationMarker();
            } else if (LeafletMapSet) {
                // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã€ãƒãƒ¼ã‚«ãƒ¼ã‚’å†è¡¨ç¤º
                addUserLocationMarker();
            }
        } else {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¸
            elements.backImg.style.display = 'block';
            elements.leafletMap.style.display = 'none';
            elements.koisiImg.style.height = '55vh';
            elements.koisiarrow.style.display = 'block';

            if (typeof KoishiFaceUpdate === 'function') {
                KoishiFaceUpdate('Img/hyoujyou_bishou_koisi.png');
            }
        }
    }

    // ========================================
    // ä½ç½®æƒ…å ±å–å¾—
    // ========================================
    function getUserLocation() {
        navigator.geolocation.getCurrentPosition(
            function (position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                console.log("ç·¯åº¦: " + latitude);
                console.log("çµŒåº¦: " + longitude);

                // Nominatim APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("åœ°åŸŸæƒ…å ±:", data.address);
                        const place = data.address.city || data.address.town || data.address.village || "ä¸æ˜ãªåœ°åŸŸ";

                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®æƒ…å ±ã‚’ä¿å­˜
                        userLocation = {
                            lat: latitude,
                            lon: longitude,
                            place: place
                        };

                        // ç”»é¢ã«è¡¨ç¤º
                        if (elements.nowLocate) {
                            elements.nowLocate.textContent = `${place} (${latitude.toFixed(1)}, ${longitude.toFixed(1)})`;
                        }

                        // åœ°å›³ãŒæ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚Œã°ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                        if (LeafletMapSet) {
                            addUserLocationMarker();
                        }
                    })
                    .catch(error => {
                        console.error("é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«å¤±æ•—:", error);
                        if (elements.nowLocate) {
                            elements.nowLocate.textContent = "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—";
                        }
                    });
            },
            function (error) {
                let errorMsg = "ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼";
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = "ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¿…è¦ã§ã™";
                        console.error("ä½ç½®æƒ…å ±ã®å–å¾—ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = "ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“";
                        console.error("ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
                        break;
                    case error.TIMEOUT:
                        errorMsg = "ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ";
                        console.error("ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
                        break;
                    default:
                        errorMsg = "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼";
                        console.error("ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                        break;
                }
                if (elements.nowLocate) {
                    elements.nowLocate.textContent = errorMsg;
                }
            }
        );
    }

    // ========================================
    // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
    // ========================================
    function initializeApp() {
        cacheElements();

        updateTime();
        timeUpdateInterval = setInterval(updateTime, 1000);

        if (elements.toggleMenuBtn && elements.menu) {
            elements.toggleMenuBtn.addEventListener('click', () => {
                toggleMenu(elements.menu, elements.toggleMenuBtn);
            });
        }

        if (elements.toggleInfoMenuBtn && elements.infomenu) {
            elements.toggleInfoMenuBtn.addEventListener('click', () => {
                toggleMenu(elements.infomenu, elements.toggleInfoMenuBtn);
            });
        }

        if (elements.pagebar) {
            elements.pagebar.addEventListener('input', (e) => {
                updateMainTextarea(parseInt(e.target.value, 10));
            });
        }

        if (elements.mapChangeBtn) {
            elements.mapChangeBtn.addEventListener('click', toggleMapMode);
        }

        // ä½ç½®æƒ…å ±ã‚’å–å¾—
        getUserLocation();

        // Androidã‚¢ãƒ—ãƒªã¨ã®é€£æºç¢ºèª
        if (typeof Android !== 'undefined' && Android !== null) {
            updateConnectionStatus(
                elements.p2pIndicator,
                elements.p2pText,
                Android.isP2PWebSocketConnected()
            );
            updateConnectionStatus(
                elements.wolfxIndicator,
                elements.wolfxText,
                Android.isWolfxWebSocketConnected()
            );
        } else {
            if (elements.p2pText) {
                elements.p2pText.textContent = 'Android APIåˆ©ç”¨ä¸å¯';
            }
            if (elements.wolfxText) {
                elements.wolfxText.textContent = 'Android APIåˆ©ç”¨ä¸å¯';
            }
        }
    }

    // ========================================
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    // ========================================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }

    window.addEventListener('beforeunload', () => {
        if (timeUpdateInterval) {
            clearInterval(timeUpdateInterval);
        }
    });
</script>
</body>

</html>