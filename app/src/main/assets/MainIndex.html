<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="scripts.js"></script>
    <script src="P2P.js"></script>
    <link rel="stylesheet" href="Styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <title>古明地こいしアプリ</title>
    <link rel="icon" href="Img/epicenter.png">
</head>

<body>
    <h1 id="now_time">2000/01/01 00:00:00</h1>
    <textarea id="maintextarea" rows="1" readonly></textarea>
    <input type="range" id="pagebar" min="0" max="0" value="0">
    <div class="koisiarrow_box">古明地こいしだよ!!</div>
    <img src="Img/baclgroundimg.jpg" id="back">
    <img src="Img/hyoujyou_bishou_koisi.png" id="koisi">

    <!-- メニュー -->
    <div id="menu">
        <h2>メニュー</h2>
        <a id="linker" target="_blank" href="settings.html">設定 </a>
        <hr>
        <h3>WebSocket 接続状態</h3>
        <div>
            <h4>P2P Quake</h4>
            <span id="p2pStatusIndicator" class="status-indicator status-disconnected"></span>
            <span id="p2pStatusText">切断</span>
        </div>

        <div>
            <h4>Wolfx JMA EEW</h4>
            <span id="wolfxStatusIndicator" class="status-indicator status-disconnected"></span>
            <span id="wolfxStatusText">切断</span>
        </div>
    </div>

    <!-- 情報メニュー -->
    <div id="infomenu">
        <h2>情報メニュー</h2>
        <button id="showLocalDataBtn">ローカルデータを表示</button>
        <div id="localDataDisplay"></div>
    </div>

    <!-- ボタン -->
    <button id="toggleMenuBtn">☰</button>
    <button id="toggleinfoMenuBtn">☰</button>

    <script>
        // --- メニュー開閉 ---
        const menu = document.getElementById('menu');
        const toggleMenuBtn = document.getElementById('toggleMenuBtn');
        toggleMenuBtn.addEventListener('click', () => {
            menu.classList.toggle('open');
        });

        const infomenu = document.getElementById('infomenu');
        const toggleinfoMenuBtn = document.getElementById('toggleinfoMenuBtn');
        toggleinfoMenuBtn.addEventListener('click', () => {
            infomenu.classList.toggle('open');
        });

        // --- 現在時刻表示 ---
        function NowTimeChange() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById("now_time").textContent =
                `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
        }
        setInterval(NowTimeChange, 1000);

        // --- データ管理 ---
        let AllWebsocketData = [];

        function MainTextarea(num) {
            const textarea = document.getElementById("maintextarea");
            if (!textarea) return;

            if (num >= 0 && num < AllWebsocketData.length) {
                const value = AllWebsocketData[num];
                textarea.value = value ?? "(空のメッセージ)";
            }
        }

        // --- データ受信時 (MainActivityから呼ばれる) ---
        function onP2PMessage(msg) {
            AllWebsocketData.push(msg);
            updatePagebar();
            MainTextarea(AllWebsocketData.length - 1);
        }

        function onWolfxMessage(msg) {
            AllWebsocketData.push(msg);
            updatePagebar();
            MainTextarea(AllWebsocketData.length - 1);
        }

        function updatePagebar() {
            const pagebar = document.getElementById("pagebar");
            pagebar.max = AllWebsocketData.length > 0 ? AllWebsocketData.length - 1 : 0;
            pagebar.value = AllWebsocketData.length > 0 ? AllWebsocketData.length - 1 : 0;
        }

        // --- スライダー操作 ---
        document.getElementById("pagebar").addEventListener("input", function () {
            const index = parseInt(this.value);
            MainTextarea(index);
        });

        // ローカルデータ表示ボタンのクリックイベント
        document.getElementById("showLocalDataBtn").addEventListener("click", () => {
            if (typeof Android !== 'undefined' && Android !== null) {
                const localData = Android.getLocalData();
                document.getElementById("localDataDisplay").textContent = localData;
            } else {
                document.getElementById("localDataDisplay").textContent = 'Android APIが利用できません。';
            }
        });

        // --- WebSocket 接続状態表示関数 ---
        function updateStatusDisplay(indicatorId, textId, isConnected) {
            const indicatorElement = document.getElementById(indicatorId);
            const textElement = document.getElementById(textId);

            if (indicatorElement && textElement) {
                if (isConnected) {
                    indicatorElement.classList.remove('status-disconnected');
                    indicatorElement.classList.add('status-connected');
                    textElement.textContent = '接続中';
                } else {
                    indicatorElement.classList.remove('status-connected');
                    indicatorElement.classList.add('status-disconnected');
                    textElement.textContent = '切断';
                }
            }
        }

        // AndroidからP2P WebSocketの状態変更通知を受け取るグローバル関数
        function onP2PStatusChange(isConnectedStr) {
            const isConnected = (isConnectedStr === 'true');
            updateStatusDisplay('p2pStatusIndicator', 'p2pStatusText', isConnected);
        }

        // AndroidからWolfx WebSocketの状態変更通知を受け取るグローバル関数
        function onWolfxStatusChange(isConnectedStr) {
            const isConnected = (isConnectedStr === 'true');
            updateStatusDisplay('wolfxStatusIndicator', 'wolfxStatusText', isConnected);
        }

        // WebViewがロードされたときに初期状態を確認
        window.onload = function () {
            if (typeof Android !== 'undefined' && Android !== null) {
                updateStatusDisplay('p2pStatusIndicator', 'p2pStatusText', Android.isP2PWebSocketConnected());
                updateStatusDisplay('wolfxStatusIndicator', 'wolfxStatusText', Android.isWolfxWebSocketConnected());
            } else {
                document.getElementById('p2pStatusText').textContent = 'Android API利用不可';
                document.getElementById('wolfxStatusText').textContent = 'Android API利用不可';
            }
        };

    </script>
</body>

</html>