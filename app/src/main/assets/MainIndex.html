<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤æ˜åœ°ã“ã„ã—ã‚¢ãƒ—ãƒª</title>
    <link rel="icon" href="Img/epicenter.png">

    <!-- å¤–éƒ¨CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="Styles.css">

    <!-- å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ(defer ã§éåŒæœŸèª­ã¿è¾¼ã¿) -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
    <script src="MainScript.js" defer></script>
    <script src="P2P.js" defer></script>
    <script src="Wolfx.js" defer></script>
</head>

<body>
    <!-- ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <h1 id="now_time" aria-live="polite">2000/01/01 00:00:00</h1>
    <textarea id="maintextarea" rows="1" readonly aria-label="ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢"></textarea>
    <input type="range" id="pagebar" min="0" max="0" value="0" aria-label="ãƒšãƒ¼ã‚¸ãƒãƒ¼">

    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º -->
    <div class="koisiarrow_box" aria-label="ã“ã„ã—ã®å¹ãå‡ºã—">å¤æ˜åœ°ã“ã„ã—ã ã‚ˆ!!</div>
    <img src="Img/baclgroundimg.jpg" id="back" alt="èƒŒæ™¯ç”»åƒ">
    <img src="Img/hyoujyou_bishou_koisi.png" id="koisi" alt="å¤æ˜åœ°ã“ã„ã—">

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <nav id="menu" aria-label="ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <h2>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <a id="linker" target="_blank" rel="noopener noreferrer" href="settings.html">è¨­å®š</a>
        <hr>
        <h3>WebSocket æ¥ç¶šçŠ¶æ…‹</h3>
        <div class="connection-status">
            <h4>P2Påœ°éœ‡æƒ…å ± API</h4>
            <span id="p2pStatusIndicator" class="status-indicator status-disconnected" aria-hidden="true"></span>
            <span id="p2pStatusText">åˆ‡æ–­</span>
        </div>
        <div class="connection-status">
            <h4>Wolfx JMA API</h4>
            <span id="wolfxStatusIndicator" class="status-indicator status-disconnected" aria-hidden="true"></span>
            <span id="wolfxStatusText">åˆ‡æ–­</span>
        </div>
    </nav>

    <!-- æƒ…å ±ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <aside id="infomenu" aria-label="æƒ…å ±ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <h2>æƒ…å ±ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    </aside>

    <!-- åˆ¶å¾¡ãƒœã‚¿ãƒ³ -->
    <button id="toggleMenuBtn" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰" aria-expanded="false">â˜°</button>
    <button id="toggleinfoMenuBtn" aria-label="æƒ…å ±ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰" aria-expanded="false">â˜°</button>
    <button id="MapChange" aria-label="åœ°å›³è¡¨ç¤ºåˆ‡æ›¿">ğŸ—ºï¸</button>

    <!-- åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="LeafletMap" role="application" aria-label="åœ°å›³"></div>

    <script>
        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let AllWebsocketData = [];
        let MapMode = false;
        let LeafletMapSet = null;
        let timeUpdateInterval = null;

        // ========================================
        // DOMè¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        // ========================================
        const elements = {};

        function cacheElements() {
            elements.nowTime = document.getElementById('now_time');
            elements.textarea = document.getElementById('maintextarea');
            elements.pagebar = document.getElementById('pagebar');
            elements.menu = document.getElementById('menu');
            elements.infomenu = document.getElementById('infomenu');
            elements.toggleMenuBtn = document.getElementById('toggleMenuBtn');
            elements.toggleInfoMenuBtn = document.getElementById('toggleinfoMenuBtn');
            elements.mapChangeBtn = document.getElementById('MapChange');
            elements.backImg = document.getElementById('back');
            elements.koisiImg = document.getElementById('koisi');
            elements.leafletMap = document.getElementById('LeafletMap');
            elements.koisiarrow = document.querySelector('.koisiarrow_box');
            elements.p2pIndicator = document.getElementById('p2pStatusIndicator');
            elements.p2pText = document.getElementById('p2pStatusText');
            elements.wolfxIndicator = document.getElementById('wolfxStatusIndicator');
            elements.wolfxText = document.getElementById('wolfxStatusText');
        }

        // ========================================
        // æ™‚åˆ»æ›´æ–°
        // ========================================
        function updateTime() {
            const now = new Date();
            const formatted = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

            if (elements.nowTime) {
                elements.nowTime.textContent = formatted;
            }
        }

        // ========================================
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ“ä½œ
        // ========================================
        function toggleMenu(menuElement, btnElement) {
            const isOpen = menuElement.classList.toggle('open');
            if (btnElement) {
                btnElement.setAttribute('aria-expanded', isOpen);
            }
        }

        // ========================================
        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢æ›´æ–°
        // ========================================
        function updateMainTextarea(index) {
            if (!elements.textarea || index < 0 || index >= AllWebsocketData.length) {
                return;
            }

            let data = AllWebsocketData[index];

            // æ–‡å­—åˆ—ã®å ´åˆã¯JSONãƒ‘ãƒ¼ã‚¹è©¦è¡Œ
            if (typeof data === 'string') {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    elements.textarea.value = '(ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿)';
                    return;
                }
            }

            // ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å¿œã˜ã¦å‡¦ç†
            if (data.code && typeof formatToTelop === 'function') {
                elements.textarea.value = formatToTelop(data);
            } else if (data.type && typeof wolfxcoverter === 'function') {
                elements.textarea.value = wolfxcoverter(data) ?? '(ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)';
            } else {
                elements.textarea.value = '(å‡¦ç†å¯¾è±¡ãªã—)';
            }
        }

        // ========================================
        // ãƒšãƒ¼ã‚¸ãƒãƒ¼æ›´æ–°
        // ========================================
        function updatePagebar() {
            if (!elements.pagebar) return;

            const maxIndex = Math.max(0, AllWebsocketData.length - 1);
            elements.pagebar.max = maxIndex;
            elements.pagebar.value = maxIndex;
        }

        // ========================================
        // WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        // ========================================
        function onP2PMessage(msg) {
            AllWebsocketData.push(msg);
            updatePagebar();
            updateMainTextarea(AllWebsocketData.length - 1);
        }

        function onWolfxMessage(msg) {
            AllWebsocketData.push(msg);
            updatePagebar();
            updateMainTextarea(AllWebsocketData.length - 1);
        }

        // ========================================
        // æ¥ç¶šçŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
        // ========================================
        function updateConnectionStatus(indicator, textElement, isConnected) {
            if (!indicator || !textElement) return;

            if (isConnected) {
                indicator.classList.remove('status-disconnected');
                indicator.classList.add('status-connected');
                textElement.textContent = 'æ¥ç¶šä¸­';
            } else {
                indicator.classList.remove('status-connected');
                indicator.classList.add('status-disconnected');
                textElement.textContent = 'åˆ‡æ–­';
            }
        }

        function onP2PStatusChange(isConnectedStr) {
            updateConnectionStatus(
                elements.p2pIndicator,
                elements.p2pText,
                isConnectedStr === 'true'
            );
        }

        function onWolfxStatusChange(isConnectedStr) {
            updateConnectionStatus(
                elements.wolfxIndicator,
                elements.wolfxText,
                isConnectedStr === 'true'
            );
        }

        // ========================================
        // åœ°å›³è¡¨ç¤ºåˆ‡æ›¿
        // ========================================
        function toggleMapMode() {
            MapMode = !MapMode;

            if (MapMode) {
                // åœ°å›³ãƒ¢ãƒ¼ãƒ‰ ON
                elements.backImg.style.display = 'none';
                elements.leafletMap.style.display = 'block';
                elements.koisiImg.style.height = '20vh';
                elements.koisiarrow.style.display = 'none';

                if (typeof KoishiFaceUpdate === 'function') {
                    KoishiFaceUpdate('Img/koisiyukuri.png');
                }

                // åœ°å›³åˆæœŸåŒ–(åˆå›ã®ã¿)
                if (!LeafletMapSet && typeof L !== 'undefined') {
                    LeafletMapSet = L.map('LeafletMap').setView([35.681236, 139.767125], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(LeafletMapSet);
                }
            } else {
                // åœ°å›³ãƒ¢ãƒ¼ãƒ‰ OFF
                elements.backImg.style.display = 'block';
                elements.leafletMap.style.display = 'none';
                elements.koisiImg.style.height = '55vh';
                elements.koisiarrow.style.display = 'block';

                if (typeof KoishiFaceUpdate === 'function') {
                    KoishiFaceUpdate('Img/hyoujyou_bishou_koisi.png');
                }
            }
        }

        // ========================================
        // åˆæœŸåŒ–å‡¦ç†
        // ========================================
        function initializeApp() {
            // DOMè¦ç´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            cacheElements();

            // æ™‚åˆ»æ›´æ–°é–‹å§‹
            updateTime();
            timeUpdateInterval = setInterval(updateTime, 1000);

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            if (elements.toggleMenuBtn && elements.menu) {
                elements.toggleMenuBtn.addEventListener('click', () => {
                    toggleMenu(elements.menu, elements.toggleMenuBtn);
                });
            }

            if (elements.toggleInfoMenuBtn && elements.infomenu) {
                elements.toggleInfoMenuBtn.addEventListener('click', () => {
                    toggleMenu(elements.infomenu, elements.toggleInfoMenuBtn);
                });
            }

            if (elements.pagebar) {
                elements.pagebar.addEventListener('input', (e) => {
                    updateMainTextarea(parseInt(e.target.value, 10));
                });
            }

            if (elements.mapChangeBtn) {
                elements.mapChangeBtn.addEventListener('click', toggleMapMode);
            }

            // Android APIæ¥ç¶šçŠ¶æ…‹ç¢ºèª
            if (typeof Android !== 'undefined' && Android !== null) {
                updateConnectionStatus(
                    elements.p2pIndicator,
                    elements.p2pText,
                    Android.isP2PWebSocketConnected()
                );
                updateConnectionStatus(
                    elements.wolfxIndicator,
                    elements.wolfxText,
                    Android.isWolfxWebSocketConnected()
                );
            } else {
                if (elements.p2pText) {
                    elements.p2pText.textContent = 'Android APIåˆ©ç”¨ä¸å¯';
                }
                if (elements.wolfxText) {
                    elements.wolfxText.textContent = 'Android APIåˆ©ç”¨ä¸å¯';
                }
            }
        }

        // ========================================
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
        // ========================================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
            }
        });
    </script>
</body>

</html>