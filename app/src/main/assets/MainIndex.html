<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- ===== メタ情報 ===== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ===== スクリプト ===== -->
    <script src="scripts.js"></script>
    <script src="P2P.js"></script>
    <script src="Wolfx.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- ===== スタイル ===== -->
    <link rel="stylesheet" href="Styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <title>古明地こいしアプリ</title>
    <link rel="icon" href="Img/epicenter.png">
</head>

<body>
    <!-- ===== 時刻表示 & メイン表示 ===== -->
    <h1 id="now_time">2000/01/01 00:00:00</h1>
    <textarea id="maintextarea" rows="1" readonly></textarea>
    <input type="range" id="pagebar" min="0" max="0" value="0">

    <!-- ===== キャラクター表示 ===== -->
    <div class="koisiarrow_box">古明地こいしだよ!!</div>
    <img src="Img/baclgroundimg.jpg" id="back">
    <img src="Img/hyoujyou_bishou_koisi.png" id="koisi">

    <!-- ===== メニュー ===== -->
    <div id="menu">
        <h2>メニュー</h2>
        <a id="linker" target="_blank" href="settings.html">設定 </a>
        <hr>
        <h3>WebSocket 接続状態</h3>
        <div>
            <h4>P2P地震情報 API</h4>
            <span id="p2pStatusIndicator" class="status-indicator status-disconnected"></span>
            <span id="p2pStatusText">切断</span>
        </div>
        <div>
            <h4>Wolfx　JMA API</h4>
            <span id="wolfxStatusIndicator" class="status-indicator status-disconnected"></span>
            <span id="wolfxStatusText">切断</span>
        </div>
    </div>

    <!-- ===== 情報メニュー ===== -->
    <div id="infomenu">
        <h2>情報メニュー</h2>
    </div>

    <!-- ===== メニュー開閉ボタン ===== -->
    <button id="toggleMenuBtn">☰</button>
    <button id="toggleinfoMenuBtn">☰</button>

    <!-- ===== スクリプト: メニュー操作・時刻表示・データ管理 ===== -->
    <script>
        // --- メニュー開閉 ---
        const menu = document.getElementById('menu');
        const toggleMenuBtn = document.getElementById('toggleMenuBtn');
        toggleMenuBtn.addEventListener('click', () => {
            menu.classList.toggle('open');
        });

        const infomenu = document.getElementById('infomenu');
        const toggleinfoMenuBtn = document.getElementById('toggleinfoMenuBtn');
        toggleinfoMenuBtn.addEventListener('click', () => {
            infomenu.classList.toggle('open');
        });

        // --- 現在時刻表示 ---
        function NowTimeChange() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById("now_time").textContent =
                `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
        }
        setInterval(NowTimeChange, 1000);

        // --- データ管理 ---
        let AllWebsocketData = [];
        function MainTextarea(num) {
            const textarea = document.getElementById("maintextarea");
            if (!textarea) return;

            if (num >= 0 && num < AllWebsocketData.length) {
                let value = AllWebsocketData[num];

                if (typeof value === "string") {
                    try {
                        value = JSON.parse(value);
                    } catch (e) {
                        textarea.value = "(無効なデータ)";
                        return;
                    }
                }

                if (value.code) {
                    textarea.value = formatToTelop(value);
                } else if (value.type) {
                    textarea.value = wolfxcoverter(value) ?? "(空のメッセージ)";
                } else {
                    textarea.value = "(処理対象なし)";
                }
            }
        }

        // --- データ受信時 ---
        function onP2PMessage(msg) {
            AllWebsocketData.push(msg);
            updatePagebar();
            MainTextarea(AllWebsocketData.length - 1);
        }

        function onWolfxMessage(msg) {
            AllWebsocketData.push(msg);
            updatePagebar();
            MainTextarea(AllWebsocketData.length - 1);
        }

        // --- ページバー更新 ---
        function updatePagebar() {
            const pagebar = document.getElementById("pagebar");
            pagebar.max = AllWebsocketData.length > 0 ? AllWebsocketData.length - 1 : 0;
            pagebar.value = AllWebsocketData.length > 0 ? AllWebsocketData.length - 1 : 0;
        }

        document.getElementById("pagebar").addEventListener("input", function () {
            const index = parseInt(this.value);
            MainTextarea(index);
        });

        // --- 接続状況表示 ---
        function updateStatusDisplay(indicatorId, textId, isConnected) {
            const indicatorElement = document.getElementById(indicatorId);
            const textElement = document.getElementById(textId);

            if (indicatorElement && textElement) {
                if (isConnected) {
                    indicatorElement.classList.remove('status-disconnected');
                    indicatorElement.classList.add('status-connected');
                    textElement.textContent = '接続中';
                } else {
                    indicatorElement.classList.remove('status-connected');
                    indicatorElement.classList.add('status-disconnected');
                    textElement.textContent = '切断';
                }
            }
        }

        function onP2PStatusChange(isConnectedStr) {
            updateStatusDisplay('p2pStatusIndicator', 'p2pStatusText', isConnectedStr === 'true');
        }

        function onWolfxStatusChange(isConnectedStr) {
            updateStatusDisplay('wolfxStatusIndicator', 'wolfxStatusText', isConnectedStr === 'true');
        }

        window.onload = function () {
            if (typeof Android !== 'undefined' && Android !== null) {
                updateStatusDisplay('p2pStatusIndicator', 'p2pStatusText', Android.isP2PWebSocketConnected());
                updateStatusDisplay('wolfxStatusIndicator', 'wolfxStatusText', Android.isWolfxWebSocketConnected());
            } else {
                document.getElementById('p2pStatusText').textContent = 'Android API利用不可';
                document.getElementById('wolfxStatusText').textContent = 'Android API利用不可';
            }
        };
    </script>
</body>

</html>
