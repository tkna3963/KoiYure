<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="SettingsStyles.css">
</head>

<body>
    <div class="header">
        <div class="header-content">
            <h1>âš™ï¸ è¨­å®š</h1>
            <a href="MainIndex.html" class="home-link">â† ãƒ›ãƒ¼ãƒ </a>
        </div>
    </div>

    <div class="container">
        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">ğŸ‘¤</div>
                <div>
                    <div class="section-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</div>
                    <div class="section-description">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã¨æ¨©é™ã®ç®¡ç†</div>
                </div>
            </div>
            <div class="settings-item">
                <div class="item-label">
                    <span class="label-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—</span>
                </div>
                <select id="userSelect">
                    <option value="townsman">ğŸ˜ï¸ ç”ºäºº</option>
                    <option value="sage">ğŸ§™ è³¢è€…</option>
                    <option value="creator">âœ¨ å‰µé€ ä¸»</option>
                </select>
                <div id="authBox">
                    <p class="auth-title">ğŸ” å‰µé€ ä¸»ã¸ã®æ˜‡æ ¼èªè¨¼</p>
                    <input type="email" id="login-email" placeholder="ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" autocomplete="email">
                    <input type="password" id="login-password" placeholder="ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password">
                    <button id="auth-btn">èªè¨¼ã—ã¦æ˜‡æ ¼</button>
                </div>
            </div>
        </div>

        <!-- ã‚¢ãƒ—ãƒªæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="settings-section">
            <div class="section-header">
                <div class="section-icon">â„¹ï¸</div>
                <div>
                    <div class="section-title">ã‚¢ãƒ—ãƒªæƒ…å ±</div>
                    <div class="section-description">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚µãƒãƒ¼ãƒˆæƒ…å ±</div>
                </div>
            </div>
            <div class="settings-item">
                <div class="item-label">
                    <span class="label-text">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
                    <span class="coming-soon">1.0.0</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgAD5WCP8bU0XcTPSkIMv2hMTeprxtPC0",
            authDomain: "koiyure-334de.firebaseapp.com",
            projectId: "koiyure-334de",
            storageBucket: "koiyure-334de.firebasestorage.app",
            messagingSenderId: "86478268234",
            appId: "1:86478268234:web:77901408b908fc408943b3",
            measurementId: "G-650W3SG6YB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const userSelect = document.getElementById("userSelect");
        const authBox = document.getElementById("authBox");
        let previousValue = userSelect.value;

        const savedUserType = localStorage.getItem("userType");
        const creatorUnlocked = localStorage.getItem("creatorUnlocked") === "true";

        if (savedUserType) {
            if (savedUserType === "creator" && creatorUnlocked) {
                userSelect.value = "creator";
                previousValue = "creator";
                authBox.style.display = "none";
                if (window.Android && window.Android.setSetting) {
                    window.Android.setSetting("user/type", "creator");
                }
            } else {
                setUserTypeFromJava(savedUserType);
            }
        }

        function setUserTypeFromJava(userType) {
            if (!userType) userType = "townsman";
            userSelect.value = userType;
            previousValue = userType;

            if (userType === "creator") {
                authBox.style.display = "block";
            } else {
                authBox.style.display = "none";
            }
        }

        userSelect.addEventListener("change", () => {
            const selected = userSelect.value;
            if (selected === "creator") {
                if (creatorUnlocked) {
                    authBox.style.display = "none";
                    previousValue = "creator";
                    localStorage.setItem("userType", "creator");
                } else {
                    authBox.style.display = "block";
                }
            } else {
                authBox.style.display = "none";
                previousValue = selected;
                localStorage.setItem("userType", selected);
            }
        });

        document.getElementById("auth-btn").addEventListener("click", async () => {
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                alert("èªè¨¼æˆåŠŸï¼å‰µé€ ä¸»ã«æ˜‡æ ¼ã—ã¾ã—ãŸâœ¨");

                userSelect.value = "creator";
                previousValue = "creator";

                localStorage.setItem("userType", "creator");
                localStorage.setItem("creatorUnlocked", "true");
                authBox.style.display = "none";
            } catch (error) {
                console.error(error);
                alert("èªè¨¼å¤±æ•—â€¦ğŸ’¦ å…ƒã®é¸æŠã«æˆ»ã—ã¾ã™");
                userSelect.value = previousValue;
                authBox.style.display = "none";
            }
        });
    </script>
</body>

</html>